---
name: middleware
category: rhel
workshop_type:
  - rhel
  - demo
tower_validate_certs: false
tower_infra_workloads:
  - redhat_cop.tower_configuration.projects
  - redhat_cop.tower_configuration.job_templates
  - redhat_cop.tower_configuration.workflow_job_templates

tower_projects:
  - name: "Intelligent-Ops"
    description: "Main deploy repo"
    organization: "Default"
    scm_type: git
    scm_update_on_launch: true
    scm_update_cache_timeout: 3600
    wait: yes
    scm_url: "https://github.com/redhattelco/intelligent-restarts"

tower_templates:
  - name: "1 - Install Dependencies"
    job_type: run
    inventory: "Workshop Inventory"
    project: "Intelligent-Ops"
    playbook: "dependencies.yml"
    credentials:
    - "Workshop Credential"

  - name: "Reverse Proxy health check"
    job_type: run
    inventory: "Workshop Inventory"
    project: "Intelligent-Ops"
    playbook: "simple.yml"
    job_tags: reverse_proxy
    credentials:
    - "Workshop Credential"

  - name: "Restart Reverse Proxy"
    job_type: run
    inventory: "Workshop Inventory"
    project: "Intelligent-Ops"
    playbook: "simple.yml"
    job_tags: restart_rp
    credentials:
    - "Workshop Credential"

  - name: "WebServer health check"
    job_type: run
    inventory: "Workshop Inventory"
    project: "Intelligent-Ops"
    playbook: "simple.yml"
    job_tags: webseal
    credentials:
    - "Workshop Credential"

  - name: "Restart WebServer"
    job_type: run
    inventory: "Workshop Inventory"
    project: "Intelligent-Ops"
    playbook: "simple.yml"
    job_tags: restart_ws
    credentials:
    - "Workshop Credential"

  - name: "App Server health check"
    job_type: run
    inventory: "Workshop Inventory"
    project: "Intelligent-Ops"
    playbook: "simple.yml"
    job_tags: mga
    credentials:
    - "Workshop Credential"

  - name: "Restart App Server"
    job_type: run
    inventory: "Workshop Inventory"
    project: "Intelligent-Ops"
    playbook: "simple.yml"
    job_tags: restart_mga
    credentials:
    - "Workshop Credential"

  - name: "All systems up"
    job_type: run
    inventory: "Workshop Inventory"
    project: "Intelligent-Ops"
    playbook: "simple.yml"
    job_tags: mga, systems_up
    credentials:
    - "Workshop Credential"

  - name: "Reboot Faulty Nodes"
    job_type: run
    inventory: "Workshop Inventory"
    project: "Intelligent-Ops"
    playbook: "reboot.yml"
    credentials:
    - "Workshop Credential"

  - name: "Can the node be restarted?"
    job_type: run
    inventory: "Workshop Inventory"
    project: "Intelligent-Ops"
    playbook: "api_call.yml"
    credentials:
    - "Workshop Credential"

  - name: "End to End Testing"
    job_type: run
    inventory: "Workshop Inventory"
    project: "Intelligent-Ops"
    playbook: "simple.yml"
    job_tags: e2e
    credentials:
    - "Workshop Credential"

tower_workflows:
  - name: "Intelligent restart workflow"
    organization: "Default"
    workflow_nodes:
      - unified_job_template: "Reverse Proxy health check"
        identifier: node101
        success_nodes:
          - node201
        failure_nodes:
          - node102
        always_nodes: []
      - unified_job_template: "Restart Reverse Proxy"
        identifier: node102
        success_nodes:
          - node201
        failure_nodes:
          - node401
        always_nodes: []
      - unified_job_template: "WebServer health check"
        identifier: node201
        success_nodes:
          - node301
        failure_nodes:
          - node202
        always_nodes: []
      - unified_job_template: "Restart WebServer"
        identifier: node202
        success_nodes:
          - node301
        failure_nodes:
          - node401
        always_nodes: []
      - unified_job_template: "App Server health check"
        identifier: node301
        success_nodes:
          - node402
        failure_nodes:
          - node302
        always_nodes: []
      - unified_job_template: "Restart App Server"
        identifier: node302
        success_nodes:
          - node402
        failure_nodes:
          - node401
        always_nodes: []
      - unified_job_template: "All systems up"
        identifier: node402
      - unified_job_template: "Can the node be restarted?"
        identifier: node401
        success_nodes:
          - node501
        failure_nodes:
          - node502
        always_nodes: []
      - unified_job_template: "Reboot Faulty Nodes"
        identifier: node501
        success_nodes:
          - node601
        failure_nodes: []
        always_nodes: []
      - unified_job_template: "End to End Testing"
        identifier: node601
      - approval_node:
          name: "Manual override - Reboot"
        identifier: node502
        success_nodes: []
      #     - node601
      #   always_nodes: []
      #   failure_nodes: []
      # - unified_job_template: "Reboot Faulty Nodes"
      #   identifier: node601
